<!doctype html>
<html lang="en">
<head>
<meta charset="utf-8"/>
<meta name="viewport" content="width=device-width,initial-scale=1"/>
<title>Spotlight World Map</title>

<!-- Leaflet CSS -->
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" crossorigin=""/>

<style>
:root{
  --green:#28a745;
  --blue:#1d4ed8;
  --panel: rgba(255,255,255,0.95);
  --shadow: 0 6px 18px rgba(11,14,22,0.25);
  --radius:10px;
}
html,body{height:100%;margin:0;font-family:Inter,system-ui,-apple-system,Segoe UI,Roboto,"Helvetica Neue",Arial;}
#map{position:absolute; top:60px; bottom:0; left:0; right:0;}
header{
  position:fixed; top:0; left:0; right:0; height:60px;
  background:#fff; display:flex; align-items:center; justify-content:space-between;
  padding:0 16px; box-shadow:var(--shadow); z-index:999;
}
header h1{margin:0; font-size:20px; font-weight:bold; color:var(--green);}
.burger{cursor:pointer; font-size:24px;}
.menu{position:absolute; top:60px; right:16px; background:var(--panel); box-shadow:var(--shadow); border-radius:10px; display:none; flex-direction:column;}
.menu button{margin:8px; padding:6px 12px; border:none; border-radius:6px; background:#f3f3f3; cursor:pointer;}
.menu button:hover{background:#e0e0e0;}
.floating-pin{position:fixed; top:100px; right:16px; width:44px; height:44px; border-radius:12px; background:var(--green); cursor:grab; display:flex; align-items:center; justify-content:center; box-shadow:var(--shadow); z-index:999;}
.floating-pin:active{cursor:grabbing;}
.floating-pin span{position:absolute; top:50px; left:-140px; width:180px; font-size:14px; background:var(--panel); padding:6px 8px; border-radius:8px; box-shadow:var(--shadow);}
</style>
</head>
<body>
<header>
  <h1>Spotlight World Map</h1>
  <div class="burger" id="burger">&#9776;</div>
  <div class="menu" id="menu">
    <button id="exportBtn">Export JSON</button>
    <button id="resetBtn">Reset World Map</button>
  </div>
</header>

<div id="map"></div>

<div class="floating-pin" id="floatingPin">
  <span>Zoom around the map to your location and drop this pin there</span>
</div>

<!-- Leaflet JS -->
<script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js" crossorigin=""></script>

<!-- Firebase SDK -->
<script src="https://www.gstatic.com/firebasejs/11.26.0/firebase-app.js"></script>
<script src="https://www.gstatic.com/firebasejs/11.26.0/firebase-database.js"></script>

<script>
  // --- Firebase setup ---
  const firebaseConfig = {
    apiKey: "AIzaSyAGOOMadCVEklcCl_nCGQ4JCh_LFmycMb4",
    authDomain: "spotlight-world-map.firebaseapp.com",
    databaseURL: "https://spotlight-world-map-default-rtdb.europe-west1.firebasedatabase.app/",
    projectId: "spotlight-world-map",
    storageBucket: "spotlight-world-map.firebasestorage.app",
    messagingSenderId: "498446317607",
    appId: "1:498446317607:web:d940455fc2a5597f1bb602"
  };
  const app = firebase.initializeApp(firebaseConfig);
  const db = firebase.database();

  // Generate unique ID per browser session
  const browserId = 'b-' + Math.random().toString(36).substr(2,9);

  // --- Map setup ---
  const map = L.map('map', {minZoom:2, maxZoom:19}).setView([20,0],2);
  const tiles = L.tileLayer('https://{s}.basemaps.cartocdn.com/light_all/{z}/{x}/{y}{r}.png', {
    attribution:'&copy; <a href="https://carto.com/">Carto</a>, &copy; <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a>',
    maxZoom:19
  }).addTo(map);

  let userMarker = null;
  const otherMarkers = {};

  // --- Floating pin drag/drop ---
  const floating = document.getElementById('floatingPin');
  let dragging=false;
  let tempMarker=null;

  floating.addEventListener('mousedown', (e)=>{
    dragging=true;
    const offsetX=e.offsetX, offsetY=e.offsetY;

    function move(e){
      floating.style.left=(e.clientX-offsetX)+'px';
      floating.style.top=(e.clientY-offsetY)+'px';
    }
    function up(e){
      document.removeEventListener('mousemove',move);
      document.removeEventListener('mouseup',up);
      dragging=false;

      // convert position to map lat/lng
      const rect = map.getContainer().getBoundingClientRect();
      const x = e.clientX - rect.left;
      const y = e.clientY - rect.top;
      if(x>=0 && y>=0 && x<=rect.width && y<=rect.height){
        const latlng = map.containerPointToLatLng([x,y]);
        dropPin(latlng);
      }
      // reset floating pin position
      floating.style.top='100px';
      floating.style.right='16px';
    }

    document.addEventListener('mousemove',move);
    document.addEventListener('mouseup',up);
  });

  function dropPin(latlng){
    if(userMarker){
      map.removeLayer(userMarker);
    }
    userMarker=L.marker(latlng,{draggable:true,icon:L.divIcon({className:'',html:'<div style="width:18px;height:18px;border-radius:50%;background:'+getUserPinColor()+';"></div>',iconSize:[18,18]})}).addTo(map);
    // push to Firebase
    const pinRef = db.ref('pins/'+browserId);
    pinRef.set({lat:latlng.lat,lng:latlng.lng,t:Date.now()});
    userMarker.on('dragend', e=>{
      const pos=e.target.getLatLng();
      pinRef.set({lat:pos.lat,lng:pos.lng,t:Date.now()});
    });
  }

  function getUserPinColor(){return '--green' in document.documentElement.style ? 'green':'#28a745';}

  // --- Listen for pins ---
  db.ref('pins').on('value', snapshot=>{
    const data = snapshot.val()||{};
    // remove all other markers
    for(const k in otherMarkers){
      map.removeLayer(otherMarkers[k]);
    }
    for(const key in data){
      if(key===browserId) continue;
      const p = data[key];
      const m = L.marker([p.lat,p.lng],{icon:L.divIcon({className:'',html:'<div style="width:18px;height:18px;border-radius:50%;background:blue;"></div>',iconSize:[18,18]})}).addTo(map);
      otherMarkers[key]=m;
    }
  });

  // --- Header burger menu ---
  const burger = document.getElementById('burger');
  const menu = document.getElementById('menu');
  burger.addEventListener('click',()=>{menu.style.display = menu.style.display==='flex'?'none':'flex';});

  document.getElementById('exportBtn').addEventListener('click', ()=>{
    db.ref('pins').once('value').then(snap=>{
      const data = snap.val()||{};
      const blob = new Blob([JSON.stringify(data,null,2)], {type:'application/json'});
      const url = URL.createObjectURL(blob);
      const a=document.createElement('a');
      a.href=url; a.download='spotlight-pins.json'; a.click();
      URL.revokeObjectURL(url);
    });
  });

  document.getElementById('resetBtn').addEventListener('click', ()=>{
    if(confirm('Delete all pins from the map?')){
      db.ref('pins').remove();
      if(userMarker) map.removeLayer(userMarker);
      for(const k in otherMarkers) map.removeLayer(otherMarkers[k]);
    }
  });
</script>
</body>
</html>
